<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    

    <title>Tomcat多实例部署及其原理 | 灯塔</title>
    <meta name="author" content="張日雄">
    
    <meta name="description" content="灯塔下的笔者">
    
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta property="og:title" content="Tomcat多实例部署及其原理"/>
    <meta property="og:site_name" content="灯塔下的笔者"/>

    
    <meta property="og:image" content="undefined"/>
    

    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="alternate" href="/atom.xml" title="灯塔下的笔者" type="application/atom+xml">
    <link rel="stylesheet" href="/css/lib/materialize.min.css">
    <link rel="stylesheet" href="/css/lib/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

    
        <link rel="stylesheet" href="/css/lib/prettify-tomorrow-night-eighties.css" type="text/css">
    
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
</head>


<body>
    <img src="/weixin_favicon.png" style="position: absolute; left: -9999px; opacity: 0; filter: alpha(opacity=0);">

    <nav class="indigo">
    <div class="nav-wrapper">
        <a href="#" data-activates="main-menu" class="button-collapse">
            <i class="fa fa-navicon"></i>
        </a>
        <div class="">
            <a href="/" class="brand-logo hide-on-med-and-down">灯塔下的笔者</a>
            <ul class="right hide-on-med-and-down">
                
                    <li>
                        <a class="menu-home " href="/" >
                            <i class="fa fa-home "></i>
                            
                            首页
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-archive " href="/archives" >
                            <i class="fa fa-archive "></i>
                            
                            归档
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                            <i class="fa fa-bookmark "></i>
                            
                            分类
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-reading " href="/reading" >
                            <i class="fa fa-book "></i>
                            
                            读书
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-about " href="/about" >
                            <i class="fa fa-user "></i>
                            
                            关于
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-search modal-trigger " href="#search" >
                            <i class="fa fa-search "></i>
                            
                            搜索
                        </a>
                    </li>
                
            </ul>
            <div>
    <ul class="side-nav indigo darken-1" id="main-menu">
        
        <li class="side-user">
            <div class="row">
                <div class="col s4 no-padding">
                    <img class="avatar-image circle responsive-img" src="/css/images/avert.png" alt="User Avatar">
                </div>
                <div class="info col s8 valign-wrapper no-padding">
                    <div class="valign">
                        <p class="name">灯塔</p>
                        <p class="desc">灯塔下的笔者</p>
                    </div>
                </div>
            </div>
        </li>
        

        
            <li class="no-padding">
                <a class="waves-effect menu-home " href="/" >
                    <i class="fa fa-home "></i>
                    
                    首页
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-archive " href="/archives" >
                    <i class="fa fa-archive "></i>
                    
                    归档
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                    <i class="fa fa-bookmark "></i>
                    
                    分类
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-reading " href="/reading" >
                    <i class="fa fa-book "></i>
                    
                    读书
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-about " href="/about" >
                    <i class="fa fa-user "></i>
                    
                    关于
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-search modal-trigger " href="#search" >
                    <i class="fa fa-search "></i>
                    
                    搜索
                </a>
            </li>
        
    </ul>

    <ul class="side-nav indigo darken-1" id="category-menu">
    

            

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/博客/">
                    博客 <span class="right">2 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/源码阅读/">
                    源码阅读 <span class="right">5 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/源码阅读/security源码导读系列/">
                    security源码导读系列 <span class="right">5 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/日常技术/">
                    日常技术 <span class="right">1 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/大型网站技术架构/">
                    大型网站技术架构 <span class="right">1 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/心尘随笔/">
                    心尘随笔 <span class="right">1 篇</span></a>
                </a>
            </li>

        

    </ul>
</div>

        </div>
    </div>
</nav>

<div id="search" class="modal search-modal">
    <div class="row">
        <div class="input-field col s12">
              <input id="search-input" type="text">
              <label for="search-input">搜索</label>
        </div>

    </div>
    <div id="search-result" class="search-result col s12">

    </div>
</div>


    <main>
        <div class="container main-container">
    <nav class="page-nav hide-on-small-only">
    <div class="nav-wrapper indigo">
        <span class="breadcrumb">当前位置（分类目录）</span>
        
            
    
    
    <a class="breadcrumb" href="/categories/大型网站技术架构/">大型网站技术架构</a>


        

        
    </div>
</nav>

<article>
    <div class="card">
        <div class="card-content">
            

            <div class="article-title">
                
    
        <h1>Tomcat多实例部署及其原理</h1>
    


            </div>
            <time class="indigo-link-context" datetime="2016-11-19T03:36:14.505Z"><a href="/2016/11/19/yunwei/1/">2016-11-19</a></time>

            
    <div class="tags-row">
        
            <a href="/tags/运维/" class="chip green accent-4">运维</a>
        
            <a href="/tags/tomcat/" class="chip green accent-4">tomcat</a>
        
    </div>


            <div class="toc indigo-link-context hide-on-med-and-down">
    <ol class="section table-of-contents"><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#1、Tomcat部署的场景分析"><span class="section table-of-contents-text">1、Tomcat部署的场景分析</span></a></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#2、我们的目标"><span class="section table-of-contents-text">2、我们的目标</span></a></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#3、tomcat架构"><span class="section table-of-contents-text">3、tomcat架构</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#整体架构图"><span class="section table-of-contents-text">整体架构图</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#分离目录"><span class="section table-of-contents-text">分离目录</span></a></li></ol></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#4、实战"><span class="section table-of-contents-text">4、实战</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#修改server-xml"><span class="section table-of-contents-text">修改server.xml</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#跟我来实施该方案"><span class="section table-of-contents-text">跟我来实施该方案</span></a></li></ol></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#5、启动测试"><span class="section table-of-contents-text">5、启动测试</span></a></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#6、结果"><span class="section table-of-contents-text">6、结果</span></a></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#7、nginx-tomcat热备"><span class="section table-of-contents-text">7、nginx+tomcat热备</span></a></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#经验之谈"><span class="section table-of-contents-text">经验之谈</span></a></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#资源进一步极端化"><span class="section table-of-contents-text">资源进一步极端化</span></a></li><li class="section table-of-contents-item section table-of-contents-level-1"><a class="section table-of-contents-link" href="#集群"><span class="section table-of-contents-text">集群</span></a></li></ol>
</div>


            <div class="entry indigo-link-context">
                <blockquote>
<p>导读：<br>昨天在跟群友做技术交流的时候,了解到，有很多大公司都是采用了高可用的，分布式的，实例沉余1+台。但是在小公司的同学也很多，他们反映并不是所有公司都有那样的资源来供你调度。往往公司只会给你一台机器，因为有些应用挂了公司也不会有损失的，我们往往一台机器就可以搞定。<br>但是，我们也要为我们做出来的应用负责，毕竟东西做出来是为了给人用的，如果做出来的东西经常挂了，谈何使用，在前期，如果公司资源紧张的情况下，可以不可以做高可用，多机器的沉余部署。但是至少是在但机上有2个进程在跑。so,在这里我们就说说这个，如何做单机多实例的部署。<br>在这里谈谈，在只有单机的资源下，如何把单机的资源压榨出来，用好单机。</p>
</blockquote>
<hr>
<h1 id="1、Tomcat部署的场景分析"><a href="#1、Tomcat部署的场景分析" class="headerlink" title="1、Tomcat部署的场景分析"></a>1、Tomcat部署的场景分析</h1><p>通常，我们对tomcat单机部署需求可以分为几种：</p>
<ul>
<li>单实例单应用 (一个tomcat 一个web应用)</li>
<li>单实例多应用 (一个tomcat多个应用)</li>
<li>多实例单应用 (多个tomcat都部署一个应用)</li>
<li>多实例多应用 (多个tomcat部署多个不同的应用)</li>
</ul>
<p><strong>第一种场景</strong>：这是我们开发中经常用到的，如果不要求周期性地维护tomcat版本，一般的做法是把打好的war包丢到webapps目录下，然后执行startup.sh脚本，并且可以在浏览器里访问就行了。<br><strong>第二种场景</strong>：是把多个应用程序的war包放在同一个tomcat的webapps目录，这样一来，关闭和启动tomca，或tomcat挂掉会影响所有项目。<br><strong>第三种场景</strong>: 各个tomcat都运行同一个应用程序，对应地需要修改不同的监听端口，这种方式通常会和apache httpd或者nginx整合使用，做一些负载均衡的处理。<br><strong>第四种场景</strong>: 相当于第一种场景的复数形式，除了修改不同的监听端口，没有本质区别。</p>
<p>一般来说，多实例部署tomcat，可以充分利用系统资源，不过这种方式，也有几个方面需要考虑：<br>多实例tomcat的更新维护，例如对tomcat进行升级等操作，我们需要考虑如何能“优雅”地对所有实例进行升级<br>尽量不要影响应用程序，在更新tomcat时，一不小心就把conf目录等全部覆盖，所以尽量要把配置文件和安装目录隔离<br>对于单应用来说，如果将war包分别置于各个tomcat的webapps目录，那么在发布新版本的war时，可能会出现某个实例更新失败，导致用户在访问时可能会访问到不同版本的web app，因此，<strong>比较好的方式就是所有tomcat实例都统一指向同一个应用程序</strong>，这样做，就可以多个tomcat用一份应用源码，简单部署，单机高可用也能实现（要配合nginx）.<br>本文重点阐述多实例应用的部署方案，但是为了解决上述几个问题，我们需要先来了解一下tomcat的一些基本情况。</p>
<h1 id="2、我们的目标"><a href="#2、我们的目标" class="headerlink" title="2、我们的目标"></a>2、我们的目标</h1><p><a href="http://www.itnose.net/img/20161025/172338.png" target="_blank" rel="external"><img src="http://www.itnose.net/img/20161025/172338.png" alt="tomcat架构" title="title"></a></p>
<hr>
<h1 id="3、tomcat架构"><a href="#3、tomcat架构" class="headerlink" title="3、tomcat架构"></a>3、tomcat架构</h1><h2 id="整体架构图"><a href="#整体架构图" class="headerlink" title="整体架构图"></a>整体架构图</h2><p><a href="http://www.itnose.net/img/20160411/10674534.gif" target="_blank" rel="external"><img src="http://www.itnose.net/img/20160411/10674534.gif" alt="tomcat架构" title="title"></a></p>
<p>这里有一台服务器，3台tomcat服务，以及一台tomcat的解构图。</p>
<h2 id="分离目录"><a href="#分离目录" class="headerlink" title="分离目录"></a>分离目录</h2><table>
<thead>
<tr>
<th style="text-align:left">目录</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">bin</td>
<td style="text-align:left">主要存放脚本文件，例如比较常用的windows和linux系统中启动和关闭脚本</td>
</tr>
<tr>
<td style="text-align:left">conf</td>
<td style="text-align:left">主要存放配置文件，其中最重要的两个配置文件是server.xml和web.xml</td>
</tr>
<tr>
<td style="text-align:left">lib</td>
<td style="text-align:left">主要存放tomcat运行所依赖的包</td>
</tr>
<tr>
<td style="text-align:left">logs</td>
<td style="text-align:left">主要存放运行时产生的日志文件，例如catalina.{date}.log等</td>
</tr>
<tr>
<td style="text-align:left">temp</td>
<td style="text-align:left">存放tomcat运行时产生的临时文件，例如开启了hibernate缓存的应用程序，会在该目录下生成一些文件</td>
</tr>
<tr>
<td style="text-align:left">webapps</td>
<td style="text-align:left">部署web应用程序的默认目录</td>
</tr>
<tr>
<td style="text-align:left">work</td>
<td style="text-align:left">主要存放由JSP文件生成的servlet（java文件以及最终编译生成的class文件）</td>
</tr>
</tbody>
</table>
<p>再介绍两个tomcat中比较重要的概念（通常也是两个系统变量）——<strong>CATALINA_HOME</strong>和<strong>CATALINA_BASE</strong>：</p>
<p><strong>CATALINA_HOME</strong>：即指向Tomcat安装路径的系统变量<br><strong>CATALINA_BASE</strong>：即指向活跃配置路径的系统变量通过设置这两个变量，就可以将tomcat的安装目录和工作目录分离，从而实现tomcat多实例的部署。<br>Tomcat官方文档指出，CATALINA_HOME路径的路径下只需要包含bin和lib目录，这也就是支持tomcat软件运行的目录，而CATALINA_BASE设置的路径可以包括上述所有目录，不过其中bin和lib目录并不是必需的，缺省时会使用CATALINA_HOME中的bin和conf。如此，我们就可以使用一个tomcat安装目录部署多个tomcat实例，这样的好处在于方便升级，就可以在不影响tomcat实例的前提下，替换掉CATALINA_HOME指定的tomcat安装目录。</p>
<p><a href="http://www.itnose.net/img/20161025/172337.png" target="_blank" rel="external"><img src="http://www.itnose.net/img/20161025/172337.png" alt="tomcat架构" title="title"></a></p>
<p> tomcat serve.xml 配置结构<br>Container容器子容器间关系图<br><a href="http://www.itnose.net/img/20160411/10674535.png" target="_blank" rel="external"><img src="http://www.itnose.net/img/20160411/10674535.png" alt="tomcat架构" title="title"></a></p>
<p> 交互图<br><a href="http://www.itnose.net/img/20160411/10674536.png" target="_blank" rel="external"><img src="http://www.itnose.net/img/20160411/10674536.png" alt="tomcat架构" title="title"></a></p>
<p> 对比下Tomcat serve.xml 的配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;Server port=&quot;8005&quot; shutdown=&quot;SHUTDOWN&quot;&gt;</div><div class="line">  &lt;Listener className=&quot;org.apache.catalina.startup.VersionLoggerListener&quot; /&gt;</div><div class="line">  &lt;Listener className=&quot;org.apache.catalina.core.AprLifecycleListener&quot; SSLEngine=&quot;on&quot; /&gt;</div><div class="line">  &lt;Listener className=&quot;org.apache.catalina.core.JreMemoryLeakPreventionListener&quot; /&gt;</div><div class="line">  &lt;Listener className=&quot;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&quot; /&gt;</div><div class="line">  &lt;Listener className=&quot;org.apache.catalina.core.ThreadLocalLeakPreventionListener&quot; /&gt;</div><div class="line"></div><div class="line">  &lt;GlobalNamingResources&gt;</div><div class="line">    &lt;Resource name=&quot;UserDatabase&quot; auth=&quot;Container&quot;</div><div class="line">              type=&quot;org.apache.catalina.UserDatabase&quot;</div><div class="line">              description=&quot;User database that can be updated and saved&quot;</div><div class="line">              factory=&quot;org.apache.catalina.users.MemoryUserDatabaseFactory&quot;</div><div class="line">              pathname=&quot;conf/tomcat-users.xml&quot; /&gt;</div><div class="line">  &lt;/GlobalNamingResources&gt;</div><div class="line">  &lt;Service name=&quot;Catalina&quot;&gt;</div><div class="line">    &lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;</div><div class="line">               connectionTimeout=&quot;20000&quot;</div><div class="line">               redirectPort=&quot;8443&quot; /&gt;</div><div class="line">    &lt;Connector port=&quot;8009&quot; protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot; /&gt;</div><div class="line">    &lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot;&gt;</div><div class="line">      &lt;Realm className=&quot;org.apache.catalina.realm.LockOutRealm&quot;&gt;</div><div class="line">        &lt;Realm className=&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;</div><div class="line">               resourceName=&quot;UserDatabase&quot;/&gt;</div><div class="line">      &lt;/Realm&gt;</div><div class="line">      &lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;</div><div class="line">            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</div><div class="line">        &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</div><div class="line">               prefix=&quot;localhost_access_log&quot; suffix=&quot;.txt&quot;</div><div class="line">               pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;</div><div class="line">      &lt;/Host&gt;</div><div class="line">    &lt;/Engine&gt;</div><div class="line">  &lt;/Service&gt;</div><div class="line">&lt;/Server&gt;</div></pre></td></tr></table></figure></p>
<hr>
<h1 id="4、实战"><a href="#4、实战" class="headerlink" title="4、实战"></a>4、实战</h1><p>端口配置</p>
<h2 id="修改server-xml"><a href="#修改server-xml" class="headerlink" title="修改server.xml"></a>修改server.xml</h2><p>在server.xml中配置了四个监听端口，分别是：<br><strong>Server Port</strong>：该端口用于监听关闭tomcat的shutdown命令，<strong>默认为8005</strong>.<br><strong>Connector Port</strong>：该端口用于监听HTTP的请求，<strong>默认为8080</strong>.<br><strong>AJP Port</strong>：该端口用于监听AJP（ Apache JServ Protocol ）协议上的请求，通常用于整合Apache Server等其他HTTP服务器，<strong>默认为8009</strong><br><strong>Redirect Port</strong>：重定向端口，出现在Connector配置中，如果该Connector仅支持非SSL的普通http请求，那么该端口会把https的请求转发到这个Redirect Port指定的端口，<strong>默认为8443</strong></p>
<p>虚拟主机配置<br>再来说Host配置，Host就是所谓的虚拟主机，对应包含了一个或者多个web应用程序，默认的Host配置如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot; unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</div></pre></td></tr></table></figure></p>
<p>其中：<br><strong>name</strong>： 虚拟主机的名称，一台主机表示了完全限定的域名或IP地址，<strong>默认为localhost</strong>，同时也是唯一的host，进入tomcat的所有http请求都会映射到该主机上<br><strong>appBase</strong>：web应用程序目录的路径，可以是CATALINA_HOME的相对路径，也可以写成绝对路径，<strong>默认情况下为$CATALINA_HOME/webappsunpackWARs</strong>： 表示是否自动解压war包<br><strong>autoDeploy</strong>：所谓的热部署，即在tomcat正在运行的情况下，如果有新的war加入，则会立即执行部署操作<br>另外再介绍一个Host中的属性—deployOnStartup：表示tomcat启动时是否自动部署appBase目录下所有的Web应用程序，默认为true。这个属性和autoDeploy会产生两次部署的“副作用”：一次是tomcat启动时就开始部署，第二次就是autoDeploy引起的热部署。因此最好将autoDeploy置为false<br>在部署<strong>多实例单应用</strong>的时候，默认的$CATALINA/webapps会因为tomcat安装目录升级产生不必要的麻烦，我们考虑将appBase的目录统一到另外的路径下。</p>
<p>Context的配置<br>最后再说明一下Context的配置，它出现在Host配置内，一个Context的配置就代表了一个web应用程序，如果配置多应用程序，就需要在Host下配置多个Context，一个简单的Context配置如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;Context path=&quot;/some&quot; docBase=&quot;someapp.war&quot; &gt;</div></pre></td></tr></table></figure></p>
<p><strong>path</strong>：表示访问入口，例如，path=”/abc”，则访问localhost:8080/abc时，就可以访问该Context对应的应用程序。如果path=””，则直接用localhost:8080就可以访问<br><strong>docBase</strong>：表示应用程序的解包目录或者war文件路径，是Host的appBase配置目录的相对路径，也可以是直接写成绝对路径，<strong>但是不要将appBase的值，作为docBase配置路径的前缀，例如appBase=”somedir”，docBase=”somedir-someapp.war”，这样的配置会导致部署错误</strong><br>通过配置Host的appBase和Context的docBase两个属性，可以将应用程序的文件和tomcat相关的目录进行分离，这样webapps目录也就没有作用了。</p>
<h2 id="跟我来实施该方案"><a href="#跟我来实施该方案" class="headerlink" title="跟我来实施该方案"></a>跟我来实施该方案</h2><ul>
<li>现在假设我们有一台已经配置好Java环境的服务器：（我用的是阿里云）</li>
<li>我已经有一个已经完成的shop.war 应用程序</li>
</ul>
<p>步骤1：<br>下载并解压tomcat<br><a href="/img/2016/11/tomcat01.jpg"><img src="/img/2016/11/tomcat01.jpg" alt="tomcat架构" title="title"></a></p>
<p>步骤2：<br>对Tomcat目录作以下调整：<br>在tomcat安装目录下创建a.ttlsa.com、b.ttlsa.com，并且将conf、logs、webapp、temp、work目录拷贝到这两个目录，然后tomcat安装目录只需要留下bin、a.ttlsa.com、b.ttlsa.com、lib这4个目录即可。配置后的目录结构如下：<br><a href="/img/2016/11/tomcat02.jpg"><img src="/img/2016/11/tomcat02.jpg" alt="tomcat架构" title="title"></a></p>
<p>如果要度tomcat 进行升级，我们只是需要对tomcat的lib 和 bin 目录进行升级即可。</p>
<p>步骤3：<br>配置站点server.xml<br>   <strong>配置a.ttlsa.com </strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;!-- 8005 改为8005 --&gt;</div><div class="line">&lt;Server port=&quot;8005&quot; shutdown=&quot;SHUTDOWN&quot;&gt;</div><div class="line">  &lt;Listener className=&quot;org.apache.catalina.startup.VersionLoggerListener&quot; /&gt;</div><div class="line">  &lt;Listener className=&quot;org.apache.catalina.core.AprLifecycleListener&quot; SSLEngine=&quot;on&quot; /&gt;</div><div class="line">  &lt;Listener className=&quot;org.apache.catalina.core.JreMemoryLeakPreventionListener&quot; /&gt;</div><div class="line">  &lt;Listener className=&quot;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&quot; /&gt;</div><div class="line">  &lt;Listener className=&quot;org.apache.catalina.core.ThreadLocalLeakPreventionListener&quot; /&gt;</div><div class="line">  </div><div class="line">  &lt;GlobalNamingResources&gt;</div><div class="line">    &lt;Resource name=&quot;UserDatabase&quot; auth=&quot;Container&quot;</div><div class="line">              type=&quot;org.apache.catalina.UserDatabase&quot;</div><div class="line">              description=&quot;User database that can be updated and saved&quot;</div><div class="line">              factory=&quot;org.apache.catalina.users.MemoryUserDatabaseFactory&quot;</div><div class="line">              pathname=&quot;conf/tomcat-users.xml&quot; /&gt;</div><div class="line">  &lt;/GlobalNamingResources&gt;</div><div class="line">  </div><div class="line">  &lt;Service name=&quot;Catalina&quot;&gt;</div><div class="line">    &lt;Connector port=&quot;8081&quot; protocol=&quot;HTTP/1.1&quot;</div><div class="line">               connectionTimeout=&quot;20000&quot;</div><div class="line">               redirectPort=&quot;8443&quot; /&gt;</div><div class="line">			   </div><div class="line">   &lt;!-- &lt;Connector port=&quot;8009&quot; protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot; /&gt; --&gt;</div><div class="line">	</div><div class="line">    &lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot;&gt;</div><div class="line">      &lt;Realm className=&quot;org.apache.catalina.realm.LockOutRealm&quot;&gt;</div><div class="line">        &lt;Realm className=&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;</div><div class="line">               resourceName=&quot;UserDatabase&quot;/&gt;</div><div class="line">      &lt;/Realm&gt;</div><div class="line">	  &lt;!--</div><div class="line">      &lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;</div><div class="line">            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</div><div class="line">        &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</div><div class="line">               prefix=&quot;localhost_access_log&quot; suffix=&quot;.txt&quot;</div><div class="line">               pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;</div><div class="line"></div><div class="line">      &lt;/Host&gt;</div><div class="line">	  --&gt;</div><div class="line"></div><div class="line">	  &lt;Host name=&quot;localhost&quot; appBase=&quot;F:\data\www\a.ttlsa.com&quot;</div><div class="line">			  unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;</div><div class="line">			  xmlValidation=&quot;false&quot; xmlNamespaceAware=&quot;false&quot;&gt;</div><div class="line">			  &lt;Context path=&quot;&quot; docBase=&quot;&quot;  reloadable=&quot;true&quot;&gt;</div><div class="line">				&lt;valve className=&quot;org.apache.catalina.valves.RemoteAddrValve&quot; /&gt;</div><div class="line">			  &lt;/Context&gt;</div><div class="line">	   &lt;/Host&gt;</div><div class="line">	  </div><div class="line">    &lt;/Engine&gt;</div><div class="line">  &lt;/Service&gt;</div><div class="line">&lt;/Server&gt;</div></pre></td></tr></table></figure></p>
<p>配置b.ttlsa.com<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;!-- 8005 改为8006 --&gt;</div><div class="line">&lt;Server port=&quot;8002&quot; shutdown=&quot;SHUTDOWN&quot;&gt;</div><div class="line">  &lt;Listener className=&quot;org.apache.catalina.startup.VersionLoggerListener&quot; /&gt;</div><div class="line">  &lt;Listener className=&quot;org.apache.catalina.core.AprLifecycleListener&quot; SSLEngine=&quot;on&quot; /&gt;</div><div class="line">  &lt;Listener className=&quot;org.apache.catalina.core.JreMemoryLeakPreventionListener&quot; /&gt;</div><div class="line">  &lt;Listener className=&quot;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&quot; /&gt;</div><div class="line">  &lt;Listener className=&quot;org.apache.catalina.core.ThreadLocalLeakPreventionListener&quot; /&gt;</div><div class="line">  </div><div class="line">  &lt;GlobalNamingResources&gt;</div><div class="line">    &lt;Resource name=&quot;UserDatabase&quot; auth=&quot;Container&quot;</div><div class="line">              type=&quot;org.apache.catalina.UserDatabase&quot;</div><div class="line">              description=&quot;User database that can be updated and saved&quot;</div><div class="line">              factory=&quot;org.apache.catalina.users.MemoryUserDatabaseFactory&quot;</div><div class="line">              pathname=&quot;conf/tomcat-users.xml&quot; /&gt;</div><div class="line">  &lt;/GlobalNamingResources&gt;</div><div class="line">  </div><div class="line">  &lt;Service name=&quot;Catalina&quot;&gt;</div><div class="line">    &lt;Connector port=&quot;8082&quot; protocol=&quot;HTTP/1.1&quot;</div><div class="line">               connectionTimeout=&quot;20000&quot;</div><div class="line">               redirectPort=&quot;8443&quot; /&gt;</div><div class="line">			   </div><div class="line">   &lt;!-- &lt;Connector port=&quot;8009&quot; protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot; /&gt; --&gt;</div><div class="line">	</div><div class="line">    &lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot;&gt;</div><div class="line">      &lt;Realm className=&quot;org.apache.catalina.realm.LockOutRealm&quot;&gt;</div><div class="line">        &lt;Realm className=&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;</div><div class="line">               resourceName=&quot;UserDatabase&quot;/&gt;</div><div class="line">      &lt;/Realm&gt;</div><div class="line">	  &lt;!-- </div><div class="line">      &lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;</div><div class="line">            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</div><div class="line">        &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</div><div class="line">               prefix=&quot;localhost_access_log&quot; suffix=&quot;.txt&quot;</div><div class="line">               pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;</div><div class="line"></div><div class="line">      &lt;/Host&gt;</div><div class="line">	  --&gt;</div><div class="line">	 </div><div class="line">	  &lt;Host name=&quot;localhost&quot; appBase=&quot;F:\data\www\a.ttlsa.com&quot;</div><div class="line">			  unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;</div><div class="line">			  xmlValidation=&quot;false&quot; xmlNamespaceAware=&quot;false&quot;&gt;</div><div class="line">			  &lt;Context path=&quot;&quot; docBase=&quot;&quot;  reloadable=&quot;true&quot;&gt;</div><div class="line">				&lt;valve className=&quot;org.apache.catalina.valves.RemoteAddrValve&quot; /&gt;</div><div class="line">			  &lt;/Context&gt;</div><div class="line">	   &lt;/Host&gt;</div><div class="line">	  </div><div class="line">    &lt;/Engine&gt;</div><div class="line">  &lt;/Service&gt;</div><div class="line">&lt;/Server&gt;</div></pre></td></tr></table></figure></p>
<p><strong>创建多实例启动脚本</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"># description: 启动tomcat多实例.#</div><div class="line">. /etc/init.d/functions</div><div class="line">RETVAL=$?</div><div class="line"># tomcat实例目录</div><div class="line">export CATALINA_BASE=&quot;$PWD&quot;</div><div class="line"># tomcat安装目录</div><div class="line">export CATALINA_HOME=&quot;/usr/local/tomcat-7.0.50&quot;</div><div class="line"># 可选</div><div class="line">export JVM_OPTIONS=&quot;-Xms128m -Xmx1024m -XX:PermSize=128m -XX:MaxPermSize=512m&quot;</div><div class="line">case &quot;$1&quot; in</div><div class="line">start)</div><div class="line">if [ -f $CATALINA_HOME/bin/startup.sh ];then</div><div class="line">echo $&quot;Start Tomcat&quot;</div><div class="line">$CATALINA_HOME/bin/startup.sh</div><div class="line">fi</div><div class="line">;;</div><div class="line">stop)</div><div class="line">if [ -f $CATALINA_HOME/bin/shutdown.sh ];then</div><div class="line">echo $&quot;Stop Tomcat&quot;</div><div class="line">$CATALINA_HOME/bin/shutdown.sh</div><div class="line">fi</div><div class="line">;;</div><div class="line">*)</div><div class="line">echo $&quot;Usage: $0 &#123;start|stop&#125;&quot;</div><div class="line">exit 1</div><div class="line">;;</div><div class="line">esac</div><div class="line">exit $RETVAL</div></pre></td></tr></table></figure></p>
<p>这段shell 脚本比较简单，主要是设置环境变量，接受命令参数 RETVAL=$? ，来执行不同的命令。 RETVAL=start/stop 等<br>export CATALINA_BASE=”$PWD” 表示设置当前路径为  CATALINA_BASE 的环境变量，一般情况下CATALINA_BASE 和 CATALINA_HOME 是默认一样的。</p>
<p><strong>启动脚本赋权限</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># chmod a+x tomcat.sh</div></pre></td></tr></table></figure></p>
<h1 id="5、启动测试"><a href="#5、启动测试" class="headerlink" title="5、启动测试"></a>5、启动测试</h1><p>启动/关闭a.ttlsa.com<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">启动</div><div class="line"> # cd /usr/local/tomcat-7.0.50/a.ttlsa.com/</div><div class="line"> # ./tomcat.sh start</div><div class="line"> 关闭</div><div class="line"> # cd /usr/local/tomcat-7.0.50/a.ttlsa.com/</div><div class="line"> # ./tomcat.sh stop</div></pre></td></tr></table></figure></p>
<p> 启动/关闭b.ttlsa.com<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">启动</div><div class="line"> # cd /usr/local/tomcat-7.0.50/a.ttlsa.com/</div><div class="line"> # ./tomcat.sh start</div><div class="line"> 关闭</div><div class="line"> # cd /usr/local/tomcat-7.0.50/a.ttlsa.com/</div><div class="line"> # ./tomcat.sh stop</div></pre></td></tr></table></figure></p>
<p>备注：一定需要cd到tomcat.sh的当前目录下执行才可以</p>
<p>在win7 下，需要创建在a.ttlsa.com 和b.ttlsa.com下面创建 startup.bat 来启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">@echo off</div><div class="line">set JAVA_HOME=D:\Program Files\Java\jdk1.8.0_112</div><div class="line">set PATH=%JAVA_HOME%\bin;%PATH%</div><div class="line">set CATALINA_BASE=%CD%</div><div class="line">cd E:\tomcat-8.5.6\bin</div><div class="line">catalina.bat start</div></pre></td></tr></table></figure>
<p>这段是在win7 下云的bat脚本，于shell脚本同理，set CATALINA_BASE=%CD% 也是设置环境变量，CD 可以获取当前的路径。</p>
<p>shell 脚本入门参考：<a href="http://sishuok.com/forum/blogPost/list/5655.html" target="_blank" rel="external">http://sishuok.com/forum/blogPost/list/5655.html</a></p>
<h1 id="6、结果"><a href="#6、结果" class="headerlink" title="6、结果"></a>6、结果</h1><p>单个Tomcat应用多个tomcat实例的配置到此，就结束了。<br>此外，我们在这里的基础上进行系统的扩展，比如如果我的Tomcat应用挂掉了，我的整个应用都将不可用了，我们应该如何处理？<br>我们可以把Tomcat复制多份，在单机的情况下，开多一个Tomcat进程，在配合Nginx 来配置，就能实现Tomcat的自动切换，这些内容，有空再写。</p>
<p>如果需要操作多个实例显得比较麻烦，大家可以自行写统一的脚本。</p>
<p><a href="/img/2016/11/tomcat03.jpg"><img src="/img/2016/11/tomcat03.jpg" alt="tomcat架构" title="title"></a><br><a href="/img/2016/11/tomcat04.jpg"><img src="/img/2016/11/tomcat04.jpg" alt="tomcat架构" title="title"></a></p>
<p>Linux 下的实现基本一致。</p>
<p>这样的好处是，显而易见的，这样能开启Tomcat的多个进程，即多台tomcat，挂了也不太怕，还有其他tomcat应用支撑，代码实例我们发版本的时候，只需要发布一份，实例代码易于维护。<br>但是，我们网站的域名和端口一般是同一采用80端口，统一的域名，而现在我们开启tomcat只能一个使用80端口，显然是不合适的·，为此我们会引入负载均衡的nginx来配置。<br>nginx 采用80 端口，tomcat分别采用8080， 8081， 8082 这样就能让我们的程序稳定的运行。<br>这样，我们就能进最大的限度来压榨单机的性能，保证应用程序的稳定的运行。<br>而然，单机不然有单机的瓶颈，毕竟单机中的cpu 已经各种硬件的限制，会大大影响实例程序的跑动，在这时，就不再是单机能抗的动的了，我们需要分析程序的瓶颈在那？数据库，那就把数据库单独分出去，单独一台机器，是文件图片服务器，就把他分出去。如果是应用程序太大，就要考虑把应用实例进行拆解为不同哦那个的组件，单独部署，这就是分布式部署。<br>当然，这都是后话，只有程序复杂到一定的程度，并体量很大的话，才会做这种架构的演变，成本和技术投入的难度也会相应的变大。<br>本章，只局限于如何玩好单机的基础上来讨论，对于分布式的那块，笔者能力有限，尚且还不能完全驾驭，不做分享。</p>
<h1 id="7、nginx-tomcat热备"><a href="#7、nginx-tomcat热备" class="headerlink" title="7、nginx+tomcat热备"></a>7、nginx+tomcat热备</h1><p>在上面的配置的基础上，我们在进一步进行扩展，进行实例的均衡和热备。<br>可以在一个服务器挂了的情况下连到另外一个，那怎么弄呢？<br>其实很简单，在upstream中的local_tomcat中配置多一个server。<br>在上面，我的a.ttlsa.com  和 b.ttlsa.com 都是访问  F:\data\www\a.ttlsa.com 下的源码的index.jsp 页面,<br>为了能观察，nginx 的keepAlive 的效果，我做一下修改：<br>a.ttlsa.com —&gt; F:\data\www\a.ttlsa.com  index.jsp 中文字是 1<br>b.ttlsa.com —&gt; F:\data\www\b.ttlsa.com  index.jsp 中文字是 2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">upstream local_tomcat &#123;  </div><div class="line">	server localhost:8081 weight=1;  </div><div class="line">	server localhost:8082 weight=5;  </div><div class="line">&#125; </div><div class="line"></div><div class="line">   server &#123;</div><div class="line">       listen       80;</div><div class="line">       server_name  localhost:8081;</div><div class="line"></div><div class="line">       #charset koi8-r;</div><div class="line"></div><div class="line">       #access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">       #location / &#123;</div><div class="line">       #    root   html;</div><div class="line">       #    index  index.html index.htm;</div><div class="line">       #&#125;		</div><div class="line">	location / &#123;  </div><div class="line">		proxy_pass http://local_tomcat;  </div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p><a href="/img/2016/11/tomcat05.gif"><img src="/img/2016/11/tomcat05.gif" alt="tomcat架构" title="title"></a></p>
<p>在通常的情况下，我们一般是指向一份源码就足够了，并且设置权值，减轻应用的压力。同时也不会出现单点的情况。</p>
<p>补充：nginx.con 配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">#user  nobody;</div><div class="line">worker_processes  1;</div><div class="line">events &#123;</div><div class="line">	worker_connections  1024;</div><div class="line">&#125;</div><div class="line">http &#123;</div><div class="line">	include       mime.types;</div><div class="line">	default_type  application/octet-stream;</div><div class="line"></div><div class="line">	sendfile        on;</div><div class="line">	#tcp_nopush     on;</div><div class="line"></div><div class="line">	#keepalive_timeout  0;</div><div class="line">	keepalive_timeout  65;</div><div class="line"></div><div class="line">	#gzip  on;</div><div class="line"></div><div class="line">	upstream local_tomcat &#123;  </div><div class="line">		server localhost:8081 weight=1;  </div><div class="line">		server localhost:8082 weight=5;  </div><div class="line">	&#125; </div><div class="line">	</div><div class="line">	server &#123;</div><div class="line">		listen       80;</div><div class="line">		server_name  localhost;</div><div class="line"></div><div class="line">		#charset koi8-r;</div><div class="line"></div><div class="line">		#access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">		#location / &#123;</div><div class="line">		#    root   html;</div><div class="line">		#    index  index.html index.htm;</div><div class="line">		#&#125;		</div><div class="line">		location / &#123;  </div><div class="line">			proxy_pass http://local_tomcat;  </div><div class="line">		&#125;  </div><div class="line">		</div><div class="line">		error_page   500 502 503 504  /50x.html;</div><div class="line">		location = /50x.html &#123;</div><div class="line">			root   html;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>综上：我们做到了多台tomcat 但是我们也能做到tomcat的简单升级，并且实现实例的负载均衡，已经应用的主备，在也不用担心应用挂掉而睡不了觉了。<br>缺点：nginx依然存在单点的问题。</p>
<p>本次的实验资源供下载：<a href="http://download.csdn.net/detail/a82793510/9687715" target="_blank" rel="external">http://download.csdn.net/detail/a82793510/9687715</a></p>
<h1 id="经验之谈"><a href="#经验之谈" class="headerlink" title="经验之谈"></a>经验之谈</h1><p>如果是在资源有限的情况下，已经选择了单机，证明不是有钱荏，我一般会把上面的权去掉，在这样我们就可以在一台tomcat应用服务器挂掉的情况下，才会访问备机Tomcat应用服务器。<br>如果只是应用的情况下，这样已经足够了。用基于IP分发的策略已经能解决绝大部分需求。 </p>
<h1 id="资源进一步极端化"><a href="#资源进一步极端化" class="headerlink" title="资源进一步极端化"></a>资源进一步极端化</h1><p>现在，我们在这台单机上已经部署了一个应用app1, 假设现在我司实在是资源太紧缺了，我们又要在这台机子上，部署另外一个应用app2。<br>那么现在我们就要对Nginx 和 Tomcat 进行改动。<br>改动一般分为2种方法：2级域名改动 或 2级目录改动。<br>先来在上面的基础上说说二级目录改动：<br>按照我们上面的，我们的目标的架构：我们已经部署了一个应用程序：some.war ，现在我要采用二级目录方式部署另外的一个应用程序：app.war。<br>那么我会在上面的基础上做如下的修改：localhost 可以修改为自己的域名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;Host name=&quot;localhost/some&quot; appBase=&quot;F:\data\www\a.ttlsa.com&quot;</div><div class="line">	  unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;</div><div class="line">	  xmlValidation=&quot;false&quot; xmlNamespaceAware=&quot;false&quot;&gt;</div><div class="line">	  &lt;Context path=&quot;&quot; docBase=&quot;&quot;  reloadable=&quot;true&quot;&gt;</div><div class="line">		&lt;valve className=&quot;org.apache.catalina.valves.RemoteAddrValve&quot; /&gt;</div><div class="line">	  &lt;/Context&gt;</div><div class="line">&lt;/Host&gt;</div><div class="line">&lt;Host name=&quot;localhost/app&quot; appBase=&quot;F:\data\www\b.ttlsa.com&quot;</div><div class="line">	  unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;</div><div class="line">	  xmlValidation=&quot;false&quot; xmlNamespaceAware=&quot;false&quot;&gt;</div><div class="line">	  &lt;Context path=&quot;&quot; docBase=&quot;&quot;  reloadable=&quot;true&quot;&gt;</div><div class="line">		&lt;valve className=&quot;org.apache.catalina.valves.RemoteAddrValve&quot; /&gt;</div><div class="line">	  &lt;/Context&gt;</div><div class="line">&lt;/Host&gt;</div></pre></td></tr></table></figure>
<p>另外的一台的service.xml 也同样如此配置。<br>nginx中的localhost 可以修改为自己的域名 如 mp.hello.io </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">     listen       80;</div><div class="line">     server_name  localhost; // 可以修改为自己的域名</div><div class="line">      </div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>二级域名的改动，<br>前提：我们有一个顶级域名：如 hello.io 这样的一个顶级域名：<br>那么，我们现在可以这样做：<br>现在万网中配置一下我们的二级域名，如som.hello.io和app.hello.io 都要在万网中指向我们的服务器Ip 地址。<br>在增加二级域名的情况下，我们可以新增2个是实例。<br>把Nginx修改为这样的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">#user  nobody;</div><div class="line">worker_processes  1;</div><div class="line">events &#123;</div><div class="line">    worker_connections  1024;</div><div class="line">&#125;</div><div class="line">http &#123;</div><div class="line">    include       mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line"></div><div class="line">    sendfile        on;</div><div class="line">    #tcp_nopush     on;</div><div class="line"></div><div class="line">    #keepalive_timeout  0;</div><div class="line">    keepalive_timeout  65;</div><div class="line"></div><div class="line">    #gzip  on;</div><div class="line"></div><div class="line">    upstream local_tomcat01 &#123;  </div><div class="line">        server localhost:8081;  </div><div class="line">        server localhost:8082;  </div><div class="line">    &#125; </div><div class="line">	 upstream local_tomcat02 &#123;  </div><div class="line">        server localhost:8083;  </div><div class="line">        server localhost:8084;  </div><div class="line">    &#125; </div><div class="line">	    server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  some.hello.io;</div><div class="line"></div><div class="line">        #charset koi8-r;</div><div class="line"></div><div class="line">        #access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">        #location / &#123;</div><div class="line">        #    root   html;</div><div class="line">        #    index  index.html index.htm;</div><div class="line">        #&#125;        </div><div class="line">        location / &#123;  </div><div class="line">            proxy_pass http://local_tomcat02;  </div><div class="line">        &#125;  </div><div class="line"></div><div class="line">        error_page   500 502 503 504  /50x.html;</div><div class="line">        location = /50x.html &#123;</div><div class="line">            root   html;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">	server &#123;</div><div class="line">        listen       80;</div><div class="line">        server_name  app.hello.io;</div><div class="line"></div><div class="line">        #charset koi8-r;</div><div class="line"></div><div class="line">        #access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">        #location / &#123;</div><div class="line">        #    root   html;</div><div class="line">        #    index  index.html index.htm;</div><div class="line">        #&#125;        </div><div class="line">        location / &#123;  </div><div class="line">            proxy_pass http://local_tomcat02;  </div><div class="line">        &#125;  </div><div class="line"></div><div class="line">        error_page   500 502 503 504  /50x.html;</div><div class="line">        location = /50x.html &#123;</div><div class="line">            root   html;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>此外，修改一下，Tomcat 的端口就可以了，同时80 81， 指向一个实例，83 84 指向另外一个实例（appBase中指定）。这样就可以做到程序的主备操作。</p>
<p>备注：service_name 的名称可以是ip 地址。<br>nginx在配置upstream时，有两个参数：<br>ip_hash（同一IP一直使用同一台server服务）<br>weight（server的使用权重，数值越大，nginx分发的请求越多） </p>
<p>通过配合这两个参数，能粗糙地解决session共享的问题。<br>对于一些不是太依赖session的应用，或者只有用户登录时保存，那么我认为可以用Cookies代替。<br>即使真的要Session共享，我认为手动写代码保存到Memcached比为Tomcat加插件好，这样能获得更好的可控性。<br>而且我不用Tomcat，用Redis，这个msm就用不上啦，不过我会按照我的思想实现session共享，呵呵，个人愚见！</p>
<p><a href="/img/2016/11/tomcat06.png"><img src="/img/2016/11/tomcat06.png" alt="tomcat架构" title="title"></a></p>
<p>最后我们的架构是这样的。在这样的解构下，我们无论是修改为 二级目录 亦或是二级域名，我们运维都只是要做很小的改动就能切换。配置和源码分离的结构，对我们以后的扩展为分布式应用，还是依然是单机的传统结构都是进可以攻退以守。<br>留有余地，唯一不足就是nginx的单点问题，不过就单机体系来说已经够用了。</p>
<h1 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h1><p>上面不架构已经是属于在单机上做了一个简单的集群了，要实现Tomcat。<br>要多台机器，只要修改上面Nginx的分发的Ip 就可，但是会话共享是一个很大的问题，但是，用基于IP分发的策略已经能解决绝大部分需求。<br>这里已经脱离了我们单机应用的主题，以后有机会探讨。</p>
<hr>
<blockquote>
<p>参考文章：<br><a href="http://www.cnblogs.com/tq03/p/3507658.html" target="_blank" rel="external">http://www.cnblogs.com/tq03/p/3507658.html</a><br><a href="http://www.itnose.net/detail/6658488.html" target="_blank" rel="external">http://www.itnose.net/detail/6658488.html</a><br><a href="http://www.ttlsa.com/tomcat/config-multi-tomcat-instance/" target="_blank" rel="external">http://www.ttlsa.com/tomcat/config-multi-tomcat-instance/</a><br><a href="http://www.cnblogs.com/_popc/p/4167516.html" target="_blank" rel="external">http://www.cnblogs.com/_popc/p/4167516.html</a><br><a href="http://www.itnose.net/detail/6485584.html" target="_blank" rel="external">http://www.itnose.net/detail/6485584.html</a><br><a href="http://www.itnose.net/detail/6521677.html" target="_blank" rel="external">http://www.itnose.net/detail/6521677.html</a><br><a href="http://www.itnose.net/detail/6448554.html" target="_blank" rel="external">http://www.itnose.net/detail/6448554.html</a><br><a href="http://www.aikaiyuan.com/7907.html" target="_blank" rel="external">http://www.aikaiyuan.com/7907.html</a><br><a href="http://blog.csdn.net/cclovett/article/details/26377269" target="_blank" rel="external">http://blog.csdn.net/cclovett/article/details/26377269</a> (nginx)<br><a href="http://www.roncoo.com/article/detail/125185" target="_blank" rel="external">http://www.roncoo.com/article/detail/125185</a></p>
</blockquote>
<hr>
<p><a href="/css/images/mm_facetoface_collect.png"><img src="/css/images/mm_facetoface_collect.png" alt="tomcat架构" title="title"></a></p>

            </div>
        </div>
    </div>
</article>




    <section id="comment">
        <div class="card">
            <div class="card-content">
                <!-- Duoshuo Comment BEGIN -->
                <div class="ds-thread" data-thread-key="2016/11/19/yunwei/1/" data-title="Tomcat多实例部署及其原理" data-url="http://yoursite.com/2016/11/19/yunwei/1/"></div>

                <script type="text/javascript">
                    console.log(document.querySelector('.ds-thread'));
                    var duoshuoQuery = {
                        short_name: 'jbeacon'
                    };
                    (function() {
                        var ds = document.createElement('script');
                        ds.type = 'text/javascript';
                        ds.async = true;
                        ds.src = (document.location.protocol == 'https:'
                            ? 'https:'
                            : 'http:') + '//static.duoshuo.com/embed.js';
                        ds.charset = 'UTF-8';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
                    })();
                </script>
                <!-- Duoshuo Comment END -->
            </div>
        </div>
    </section>



</div>

        <div class="fixed-action-btn float-sitemap">
    <a class="btn-floating btn-large green">
      <i class="fa fa-caret-square-o-up"></i>
    </a>
    <ul>
      <li><a class="btn-return-top btn-floating waves-effect blue" title="回到顶部"><i class="fa fa-arrow-circle-o-up"></i></a></li>
      <li><a class="btn-floating waves-effect button-collapse orange"  data-activates="main-menu" title="menu"><i class="fa fa-navicon"></i></a></li>
    </ul>
  </div>

    </main>
    <footer class="page-footer indigo darken-1">
    
    <div class="container">
        <div class="row">
            
            <div class="social-group col m3 s12">
                <h5 class="white-text">社交</h5>
                
                    <a class="social-link" href="http://weibo.com/3099694953/profile?topnav=1&amp;wvr=6&amp;is_all=1" target="_blank">
                        <i class="fa fa-2x fa-weibo"></i>
                    </a>
                
                    <a class="social-link" href="https://github.com/RiXiong" target="_blank">
                        <i class="fa fa-2x fa-github"></i>
                    </a>
                
                    <a class="social-link" href="/atom.xml" target="_blank">
                        <i class="fa fa-2x fa-rss"></i>
                    </a>
                
            </div>
            

            
            <div class="col m9 s12">
                <h5 class="white-text">友情链接</h5>
                
                    <a class="social-link" href="http://raytaylorlin.com/" target="_blank">raytaylorism主题作者的技术博客</a>
                
                    <a class="social-link" href="https://github.com/raytaylorlin" target="_blank">Github地址（测试友情链接）</a>
                
            </div>
            
        </div>
    </div>
    

    <div class="footer-copyright indigo-link-context">
        <div class="container">
            © 2016 jbeacon.top, All rights reserved.
            <p class="right" style="margin-top: 0;">本博客由 <a href="https://hexo.io">Hexo</a> 强力驱动 | 主题 <a href="https://github.com/raytaylorlin/hexo-theme-raytaylorism">raytaylorism</a></p>
        </div>
    </div>
</footer>


    <noscript>
    <div class="noscript">
        <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
    </div>
</noscript>
<div class="noscript">
    <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
</div>


<script src="/js/jquery.min.js"></script>
<script src="/js/materialize.min.js"></script>

<script>
    (function($) {
        $(document).ready(function() {
            // 隐藏禁用javascript（针对微信内置浏览器）的提示
            $('.noscript').hide();

            // 图片缩放效果
            var $imgs = $('img').not('.slider-image').not('.avatar-image').not('.carousel-image').not('.card-cover-image').not('.qrcode');

            // 给图片加上点击放大效果（materialbox插件）
            $imgs.addClass('materialboxed').each(function(i, el) {
                $(this).attr('data-caption', $(this).attr('alt') || ' ');
            }).materialbox();

            // 优化表格的显示
            $('table').each(function() {
                var $table = $(this);
                // 除去多行代码的情况
                if ($table.find('pre').length == 0) {
                    $table.addClass('responsive-table striped bordered');
                }
            });

            // 首页幻灯片
            $('.slider').slider({indicators: true, full_width: true, interval: 8000});

            $(".button-collapse").sideNav();
            $(".category-menu").sideNav();

            // 针对gallery post
            $('.carousel').carousel({full_width: true});
            $('.carousel-control.prev').click(function() {
                $('.carousel').carousel('prev');
            });
            $('.carousel-control.next').click(function() {
                $('.carousel').carousel('next');
            });

            // 文章目录
            $('article').not('.simple-article').find('h1').add('h2').add('h3').add('h4').add('h5').add('h6').scrollSpy();
            // 修正文章目录的left-border颜色
            var color = $('.table-of-contents-text').css('color');
            $('.table-of-contents-link').css('border-left-color', color);

            // 针对移动端做的优化：FAB按钮点击一下收回
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                $('.fixed-action-btn').addClass('click-to-toggle');
            }
            // 回到顶部
            $('.btn-return-top').click(function() {
                $('body, html').animate({
                    scrollTop: 0
                }, 500);
            });

            // 重置读书页面的Tab标签页的颜色
            $('li.tab a').hover(function() {
                $(this).toggleClass('text-lighten-4');
            });
            $('.indicator').addClass('green lighten-2');

            
            // 添加new标签
            $('.menu-reading, .menu-about').append('<span class="new badge pink"></span>');
            

            // 搜索功能
            $('.modal-trigger').leanModal({
                // 打开搜索框时自动聚焦
                ready: function() {
                    if ($('#search').is(":visible")) {
                        $('#search-input').focus();
                    }
                }
            });
            var searchXml = "search.xml";
            if (searchXml.length == 0) {
             	searchXml = "search.xml";
            }
            var searchPath = "/" + searchXml;
            initSearch(searchPath, 'search-input', 'search-result');
        });

        // 初始化搜索与匹配函数
        var initSearch = function(path, search_id, content_id) {
            'use strict';
            $.ajax({
                url: path,
                dataType: "xml",
                success: function(xmlResponse) {
                    // get the contents from search data
                    var datas = $("entry", xmlResponse).map(function() {
                        return {
                            title: $("title", this).text(),
                            content: $("content", this).text(),
                            url: $("url", this).text()
                        };
                    }).get();
                    var $input = document.getElementById(search_id);
                    var $resultContent = document.getElementById(content_id);
                    $input.addEventListener('input', function() {
                        var str = '<ul class=\"search-result-list\">';
                        var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                        $resultContent.innerHTML = "";
                        if (this.value.trim().length <= 0) {
                            return;
                        }
                        // perform local searching
                        datas.forEach(function(data) {
                            var isMatch = true;
                            var content_index = [];
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                            var data_url = data.url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty titles and contents
                            if (data_title != '' && data_content != '') {
                                keywords.forEach(function(keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);
                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i == 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            }
                            // show search results
                            if (isMatch) {
                                keywords.forEach(function(keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    data_title = data_title.replace(regS, "<span class=\"search-keyword indigo lighten-2\">" + keyword + "</span>");
                                });

                                str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 100 characters
                                    var start = first_occur - 20;
                                    var end = first_occur + 80;
                                    if (start < 0) {
                                        start = 0;
                                    }
                                    if (start == 0) {
                                        end = 100;
                                    }
                                    if (end > content.length) {
                                        end = content.length;
                                    }
                                    var match_content = content.substring(start, end);
                                    // highlight all keywords
                                    keywords.forEach(function(keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, "<span class=\"search-keyword indigo lighten-2\">" + keyword + "</span>");
                                    });

                                    str += "<p class=\"search-result\">..." + match_content + "...</p>"
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        $resultContent.innerHTML = str;
                    });
                }
            });
        }
    })(jQuery);
</script>


<script src="/js/prettify.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $("pre").addClass("prettyprint");
        prettyPrint();
    });
</script>




<script type="text/javascript" src="http://tajs.qq.com/stats?sId=a4Ho46rhVw4-PQxU" charset="UTF-8"></script>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>
<script type="text/javascript" async
  src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>



</body>
</html>
